<%# Profile Page for Users %>
<div class="account-profile-wrapper">
  <!-- Profile Header -->
  <header class="account-profile-header">
    <div class="account-profile-header-content">
      <div class="account-profile-avatar-section">
        <div class="account-profile-avatar">
          <% if @account.avatar.attached? %>
            <%= image_tag @account.avatar, class: "rounded-circle profile-avatar-img" %>
          <% else %>
            <div class="rounded-circle bg-light me-3" style="width: 45px; height: 45px; border: 1px solid #dbdbdb;"></div>
          <% end %>
        </div>
      </div>

      <div class="account-profile-info-section">
        <div class="account-profile-name-row">
          <h1 class="account-profile-username"><%= @account.username %></h1>
          
          <!-- Action Buttons -->
          <div class="account-profile-actions">
            <% if current_account == @account %>
              <%= link_to "Редагувати", edit_profile_path, class: "btn-edit-account" %>
            <% elsif current_account && current_account != @account %>
              <% if current_account.following?(@account) %>
                <% rel = current_account.following_relationships.find_by(followed_id: @account.id) %>
                <%= button_to "Відписатися", relationship_path(rel), method: :delete, class: "btn-following" %>
              <% else %>
                <%= button_to "Підписатися", relationships_path(followed_id: @account.id), method: :post, class: "btn-follow" %>
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- Stats -->
        <ul class="account-profile-stats">
          <li>
            <span class="stat-number"><%= @account.posts.count %></span>
            <span class="stat-label">постів</span>
          </li>
          <li>
            <%= link_to followers_account_path(@account), class: "stat-link" do %>
              <span class="stat-number"><%= @account.followers.count %></span>
              <span class="stat-label">підписники</span>
            <% end %>
          </li>
          <li>
            <%= link_to following_account_path(@account), class: "stat-link" do %>
              <span class="stat-number"><%= @account.following.count %></span>
              <span class="stat-label">підписань</span>
            <% end %>
          </li>
        </ul>

        <!-- Bio -->
        <div class="account-profile-bio">
          <p class="bio-name"><strong><%= @account.username %></strong></p>
          <% if @account.description.present? %>
            <p class="bio-text"><%= @account.description %></p>
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs Navigation -->
  <div class="account-tabs-section">
    <div class="account-tabs-container">
      <nav class="account-profile-tabs">
        <div class="nav nav-tabs justify-content-center gap-5">
          <%= link_to account_path(@account, tab: 'posts'), class: "nav-link "+(@tab == 'posts' ? 'active' : '') do %>
            <i class="bi bi-grid text-dark fs-4" aria-hidden="true"></i>
          <% end %>
          <% if current_account == @account %>
            <%= link_to account_path(@account, tab: 'saved'), class: "nav-link "+(@tab == 'saved' ? 'active' : '') do %>
              <i class="bi bi-bookmark text-dark fs-4"></i>
            <% end %>
            <%= link_to account_path(@account, tab: 'liked'), class: "nav-link "+(@tab == 'liked' ? 'active' : '') do %>
              <i class="bi bi-heart text-danger fs-4"></i>
            <% end %>
          <% end %>
        </div>
      </nav>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="account-profile-content">
    <% if @tab == 'posts' %>
      <div class="account-posts-grid d-flex flex-wrap gap-1">
        <% @posts.each do |post| %>
          <div class="grid-item">
            <% if post.image.attached? %>
              <%= link_to post_path(post) do %>
                <%= image_tag post.image, class: "grid-image" %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% elsif @tab == 'saved' %>
      <div class="account-saved-grid d-flex flex-wrap gap-1">
        <% if @saved_posts.any? %>
          <% @saved_posts.each do |post| %>
            <div class="grid-item">
              <% if post.image.attached? %>
                <%= link_to post_path(post) do %>
                  <%= image_tag post.image, class: "grid-image" %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted text-center">You haven't saved any posts yet.</p>
        <% end %>
      </div>
    <% elsif @tab == 'liked' %>
      <div class="account-liked-grid d-flex flex-wrap gap-1">
        <% if @liked_posts.any? %>
          <% @liked_posts.each do |post| %>
            <div class="grid-item">
              <% if post.image.attached? %>
                <%= link_to post_path(post) do %>
                  <%= image_tag post.image, class: "grid-image" %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted text-center">You haven't liked any posts yet.</p>
        <% end %>
      </div>
    <% else %>
      <!-- Default posts feed if no tab specified -->
      <div class="account-posts-feed">
        <% if @posts.any? %>
          <% @posts.each do |post| %>
            <div class="account-post-card">
              <!-- Post Header -->
              <div class="account-post-header">
                <div class="account-post-user">
                  <div class="account-post-avatar">
                    <span class="account-avatar-small"><%= post.account.username.first.upcase %></span>
                  </div>
                  <div class="account-post-user-info">
                    <%= link_to post.account.username, account_path(post.account), class: "account-post-username" %>
                    <span class="account-post-time"><%= time_ago_in_words(post.created_at) %> ago</span>
                  </div>
                </div>
              </div>

              <!-- Post Image -->
              <% if post.image.attached? %>
                <div class="account-post-image">
                  <%= image_tag post.image, class: "account-image" %>
                </div>
              <% end %>

              <!-- Post Body -->
              <div class="account-post-body">
                <p class="account-post-text">
                  <strong><%= link_to post.account.username, account_path(post.account), class: "account-post-username-link" %></strong>
                  <%= post.body %>
                </p>
              </div>

              <!-- Post Actions -->
              <div class="account-post-actions">
                <%= render "posts/post_actions", post: post %>
              </div>

              <!-- Comments Preview -->
              <% if post.comments.any? %>
                <div class="account-post-comments-preview">
                  <% post.comments.limit(1).each do |comment| %>
                    <div class="account-comment-preview">
                      <strong><%= link_to comment.account.username, account_path(comment.account), class: "account-comment-username" %></strong>
                      <span class="account-comment-text"><%= comment.body %></span>
                    </div>
                  <% end %>
                  <% if post.comments.count > 1 %>
                    <div class="account-view-more-comments">
                      <%= link_to "Переглянути всі #{post.comments.count} коментарів", post_path(post), class: "account-view-all-link" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div class="account-empty-posts">
            <p>Немає постів</p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .account-profile-wrapper {
    background: var(--bg);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  }

  .account-profile-header {
    background: var(--bg);
    border-bottom: 1px solid var(--border-color);
  }

  .account-profile-header-content {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
    display: flex;
    gap: 40px;
    align-items: flex-start;
  }

  .account-profile-avatar-section {
    flex-shrink: 0;
  }

  .account-profile-avatar {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .account-avatar-letter {
    color: white;
    font-size: 48px;
    font-weight: 700;
  }

  .account-profile-info-section {
    flex: 1;
  }

  .account-profile-name-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .account-profile-username {
    font-size: 32px;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }

  .account-profile-actions {
    display: flex;
    gap: 8px;
  }

  .btn-edit-account,
  .btn-follow,
  .btn-following {
    padding: 8px 20px;
    border: none;
    border-radius: 24px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
    display: inline-block;
  }

  .btn-edit-account {
    background: var(--sidebar-bg);
    color: var(--text);
    border: 1px solid var(--border-color);
  }

  .btn-edit-account:hover {
    background: var(--nav-item-hover);
  }

  .btn-follow {
    background: #0095f6;
    color: white;
  }

  .btn-follow:hover {
    background: #1877f2;
    box-shadow: 0 4px 12px rgba(0, 149, 246, 0.4);
  }

  .btn-following {
    background: var(--bg);
    color: #0095f6;
    border: 1px solid #0095f6;
  }

  .btn-following:hover {
    background: var(--nav-item-hover);
  }

  .account-profile-stats {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
    display: flex;
    gap: 40px;
  }

  .account-profile-stats li {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-number {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    display: block;
  }

  .stat-label {
    font-size: 13px;
    color: #999;
    margin-top: 4px;
  }

  .stat-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s ease;
  }

  .stat-link:hover {
    color: #0095f6;
  }

  .stat-link:hover .stat-number {
    color: #0095f6;
  }

  .account-profile-bio {
    margin-top: 20px;
  }

  .bio-name {
    margin: 0 0 8px 0;
    font-weight: 600;
    color: var(--text);
    font-size: 14px;
  }

  .bio-text {
    margin: 0;
    color: #999;
    font-size: 14px;
    line-height: 1.5;
  }

  .account-profile-content {
    max-width: 700px;
    margin: 30px auto;
    padding: 0 20px 40px;
  }

  .account-posts-feed {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .account-post-card {
    background: var(--bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: box-shadow 0.3s ease;
  }

  .account-post-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  }

  .account-post-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
  }

  .account-post-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .account-post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .account-avatar-small {
    color: white;
    font-weight: 700;
    font-size: 16px;
  }

  .account-post-user-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .account-post-username {
    font-weight: 600;
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
  }

  .account-post-username:hover {
    color: #999;
  }

  .account-post-time {
    font-size: 12px;
    color: #999;
  }

  .account-post-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    background: var(--sidebar-bg);
  }

  .account-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .account-post-body {
    padding: 12px 16px;
  }

  .account-post-text {
    margin: 0;
    font-size: 14px;
    line-height: 1.5;
  }

  .account-post-username-link {
    color: var(--text);
    text-decoration: none;
    font-weight: 600;
  }

  .account-post-username-link:hover {
    text-decoration: underline;
  }

  .account-post-actions {
    padding: 12px 16px;
    display: flex;
    gap: 16px;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
  }

  .account-post-comments-preview {
    padding: 12px 16px;
  }

  .account-comment-preview {
    margin-bottom: 8px;
    font-size: 13px;
  }

  .account-comment-username {
    color: var(--text);
    text-decoration: none;
    font-weight: 600;
  }

  .account-comment-username:hover {
    text-decoration: underline;
  }

  .account-comment-text {
    color: #999;
    margin-left: 6px;
  }

  .account-view-more-comments {
    margin-top: 12px;
  }

  .account-view-all-link {
    color: #999;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
  }

  .account-view-all-link:hover {
    color: var(--text);
  }

  .account-empty-posts {
    text-align: center;
    padding: 60px 20px;
    color: #999;
    font-size: 16px;
  }

  /* Tabs and Grid Styles */
  .account-tabs-section {
    background: var(--bg);
    border-bottom: 1px solid var(--border-color);
  }

  .account-tabs-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .account-profile-tabs .nav-tabs {
    border-bottom: none;
  }

  .account-profile-tabs .nav-link {
    border: none;
    background: none;
    padding: 20px 0;
    color: #8e8e8e;
    transition: color 0.2s ease;
  }

  .account-profile-tabs .nav-link:hover {
    color: var(--text);
  }

  .account-profile-tabs .nav-link.active {
    border: none;
    border-bottom: 2px solid var(--text);
    color: var(--text);
    background: none;
  }

  /* Dark mode fixes */
  .dark-mode .account-profile-header {
    background: var(--sidebar-bg) !important;
  }

  .dark-mode .btn-follow {
    background: #0095f6 !important;
    color: white !important;
  }

  .dark-mode .account-tabs-section {
    background: var(--sidebar-bg) !important;
  }

  .grid-item {
    flex: 0 0 calc(33.333% - 0.67rem);
    aspect-ratio: 1 / 1;
    overflow: hidden;
  }

  .grid-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .grid-item:hover .grid-image {
    transform: scale(1.05);
  }

  @media (max-width: 768px) {
    .grid-item {
      flex: 0 0 calc(50% - 0.5rem);
    }
  }

  @media (max-width: 480px) {
    .grid-item {
      flex: 0 0 100%;
    }
  }

  @media (max-width: 768px) {
    .account-profile-header-content {
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 30px 15px;
      gap: 30px;
    }

    .account-profile-avatar {
      width: 100px;
      height: 100px;
    }

    .account-avatar-letter {
      font-size: 40px;
    }

    .account-profile-username {
      font-size: 24px;
    }

    .account-profile-name-row {
      justify-content: center;
    }

    .account-profile-stats {
      justify-content: center;
      gap: 30px;
    }
  }

  @media (max-width: 480px) {
    .account-profile-stats {
      gap: 20px;
    }

    .account-profile-username {
      font-size: 20px;
    }
  }
</style>